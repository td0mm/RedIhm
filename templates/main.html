<!DOCTYPE html>
<html>
<head>
  <title>RedTeam Dashboard</title>
  <link rel="stylesheet" href="{{ bootstrap_css }}">
  <script>
    function toggleAll(open) {
      document.querySelectorAll('.accordion-collapse')
              .forEach(el => el.classList.toggle('show', open));
    }
  </script>
</head>
<body class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="m-0">RedTeam Dashboard</h1>
    <a href="{{ url_for('timeline') }}" class="btn btn-outline-primary">üìú Voir la timeline</a>
  </div>

  <!-- Upload section -->
  <h3>Uploader un fichier Masscan</h3>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    <div class="input-group">
      <input type="file" name="file" class="form-control">
      <button type="submit" class="btn btn-primary">Uploader</button>
    </div>
  </form>

  <!-- Filtres -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="Rechercher IP ou notes">
    </div>
    <div class="col-md-3">
      <input type="text" name="tag" value="{{ tag_filter }}" class="form-control" placeholder="Filtrer par tag">
    </div>
    <div class="col-md-3">
      <select name="priority" class="form-select">
        <option value="">Toutes priorit√©s</option>
        <option value="faible" {% if priority_filter == 'faible' %}selected{% endif %}>Faible</option>
        <option value="moyenne" {% if priority_filter == 'moyenne' %}selected{% endif %}>Moyenne</option>
        <option value="√©lev√©e" {% if priority_filter == '√©lev√©e' %}selected{% endif %}>√âlev√©e</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-outline-secondary w-100">Filtrer</button>
    </div>
  </form>

<!-- Stats -->
<h4>üìä Statistiques</h4>
<ul>
  <li><strong>Total h√¥tes :</strong> {{ hosts|length }}</li>
  <li><strong>Total de ports ouverts :</strong> {{ total_ports }}</li>
  <li><strong>Par priorit√© :</strong>
    {% for level, count in priority_counts.items() %}
      <span class="badge
        {% if level == '√©lev√©e' %}bg-danger
        {% elif level == 'moyenne' %}bg-warning text-dark
        {% else %}bg-secondary{% endif %} me-2">
        {{ level }}: {{ count }}
      </span>
    {% endfor %}
  </li>
  <li><strong>Top 10 ports ouverts :</strong>
    {% for port, count in port_stats.items() %}
      <span class="badge bg-primary me-1">{{ port }} ({{ count }})</span>
    {% endfor %}
  </li>
</ul>

  <!-- Accord√©on -->
  <div class="d-flex justify-content-end mb-2">
    <button onclick="toggleAll(true)" class="btn btn-sm btn-outline-success me-2">Tout ouvrir</button>
    <button onclick="toggleAll(false)" class="btn btn-sm btn-outline-danger">Tout fermer</button>
  </div>

  <div class="accordion" id="hostAccordion">
    {% for host in hosts %}
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
            {{ host[0] }} ‚Äî 
            {% if host[4] == '√©lev√©e' %}
              <span class="badge bg-danger">Priorit√© √©lev√©e</span>
            {% elif host[4] == 'moyenne' %}
              <span class="badge bg-warning text-dark">Priorit√© moyenne</span>
            {% elif host[4] == 'faible' %}
              <span class="badge bg-secondary">Priorit√© faible</span>
            {% endif %}
          </button>
        </h2>
        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse">
          <div class="accordion-body">
            <form method="post">
              <input type="hidden" name="ip" value="{{ host[0] }}">
              <div class="mb-2">
                <label>Tags (s√©par√©s par virgule)</label>
                <input type="text" name="tags" value="{{ host[1] }}" class="form-control">
              </div>
              <div class="mb-2">
                <label>Checklist</label>
                <textarea name="checklist" class="form-control">{{ host[2] }}</textarea>
              </div>
              <div class="mb-2">
                <label>Notes</label>
                <textarea name="notes" class="form-control">{{ host[3] }}</textarea>
              </div>
              <div class="mb-2">
                <label>Priorit√©</label>
                <select name="priority" class="form-select">
                  <option value="">Non d√©fini</option>
                  <option value="faible" {% if host[4] == 'faible' %}selected{% endif %}>Faible</option>
                  <option value="moyenne" {% if host[4] == 'moyenne' %}selected{% endif %}>Moyenne</option>
                  <option value="√©lev√©e" {% if host[4] == '√©lev√©e' %}selected{% endif %}>√âlev√©e</option>
                </select>
              </div>
              <div class="mb-2">
                <label>Nouvelle action</label>
                <input type="text" name="action" class="form-control" placeholder="ex : dump lsass, persistence‚Ä¶">
              </div>
              <div class="mb-3">
                <label>Type d'action</label>
                <select name="action_type" class="form-select">
                  <option value="info">‚ÑπÔ∏è Info</option>
                  <option value="access:host">üî• Acc√®s machine</option>
                  <option value="access:account">üîë Acc√®s compte</option>
                  <option value="persistence">üõ† Persistance</option>
                  <option value="move:lateral">‚û°Ô∏è Mouvement lat√©ral</option>
                  <option value="exfiltration">üì¶ Exfiltration</option>
                </select>
              </div>
              <button type="submit" class="btn btn-sm btn-success">Sauvegarder</button>
            </form>

            <hr>

            <h5>Ports ouverts</h5>
            <ul class="list-group mb-3">
              {% for port, proto in ports_data[host[0]] %}
                <li class="list-group-item">{{ proto }}/{{ port }}</li>
              {% endfor %}
            </ul>

            {% if actions_data[host[0]] %}
              <h5>Timeline des actions</h5>
              {% set color_map = {
                'info': 'bg-primary',
                'access:host': 'bg-danger',
                'access:account': 'bg-danger',
                'persistence': 'bg-warning text-dark',
                'move:lateral': 'bg-secondary',
                'exfiltration': 'bg-dark'
              } %}
              <ul class="list-group">
                {% for ts, action, typ in actions_data[host[0]] %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                      <span class="badge {{ color_map.get(typ, 'bg-info') }} me-2">{{ typ }}</span>
                      {{ action }}
                    </span>
                    <small class="text-muted">{{ ts }}</small>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
