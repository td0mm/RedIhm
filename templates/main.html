<!DOCTYPE html>
<html>
<head>
  <title>RedTeam Dashboard</title>
  <link rel="stylesheet" href="{{ bootstrap_css }}">
  <script>
    function toggleAll(open) {
      const acc = document.querySelectorAll('.accordion-collapse');
      acc.forEach(el => el.classList.toggle('show', open));
    }
  </script>
</head>
<body class="container py-4">
  <h1 class="mb-4">RedTeam Dashboard</h1>

  <!-- Upload Section -->
  <h3>Uploader un fichier Masscan</h3>
  <form method="post" enctype="multipart/form-data" class="mb-4">
    <div class="input-group">
      <input type="file" name="file" class="form-control">
      <button type="submit" class="btn btn-primary">Uploader</button>
    </div>
  </form>

  <!-- Search Filters -->
  <h3>Filtres</h3>
  <form method="get" class="row g-2 mb-4">
    <div class="col-md-3">
      <input type="text" name="search" value="{{ search }}" placeholder="Recherche IP/notes..." class="form-control">
    </div>
    <div class="col-md-3">
      <input type="text" name="tag" value="{{ tag_filter }}" placeholder="Filtrer par tag" class="form-control">
    </div>
    <div class="col-md-3">
      <select name="priority" class="form-select">
        <option value="">Filtrer par priorit√©</option>
        <option value="√âlev√©e" {% if priority_filter == '√âlev√©e' %}selected{% endif %}>üî¥ √âlev√©e</option>
        <option value="Moyenne" {% if priority_filter == 'Moyenne' %}selected{% endif %}>üü† Moyenne</option>
        <option value="Faible" {% if priority_filter == 'Faible' %}selected{% endif %}>üü° Faible</option>
      </select>
    </div>
    <div class="col-md-3">
      <button type="submit" class="btn btn-outline-secondary w-100">Rechercher</button>
    </div>
  </form>

  <!-- Dashboard Stats -->
  <div class="row mb-4">
    <div class="col-md-4">
      <h4>Tags</h4>
      <ul class="list-group">
        {% for tag, count in tags_summary.items() %}
          <li class="list-group-item d-flex justify-content-between">
            {{ tag }}
            <span class="badge bg-info">{{ count }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-md-4">
      <h4>Top 10 ports ouverts</h4>
      <ul class="list-group">
        {% for port, count in port_stats.items() %}
          <li class="list-group-item d-flex justify-content-between">
            Port {{ port }}
            <span class="badge bg-dark">{{ count }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="col-md-4">
      <h4>Priorit√©s</h4>
      <ul class="list-group">
        {% for level in ['√âlev√©e', 'Moyenne', 'Faible'] %}
          {% set badge_class = {
            '√âlev√©e': 'bg-danger',
            'Moyenne': 'bg-warning text-dark',
            'Faible': 'bg-light text-dark border'
          }[level] %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ level }}
            <span class="badge {{ badge_class }}">{{ priority_counts.get(level, 0) }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Hosts List -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3>H√¥tes d√©tect√©s ({{ hosts | length }})</h3>
    <div>
      <button class="btn btn-outline-success me-2" onclick="toggleAll(true)">Tout ouvrir</button>
      <button class="btn btn-outline-danger" onclick="toggleAll(false)">Tout fermer</button>
    </div>
  </div>

  <div class="accordion" id="hostAccordion">
    {% for host in hosts %}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="heading{{ loop.index }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
          {{ host[0] }} ‚Äî
          <span class="ms-2 badge bg-secondary">{{ host[1] or 'aucun tag' }}</span>
          {% if host[4] %}
            {% set prio_class = {
              '√âlev√©e': 'bg-danger',
              'Moyenne': 'bg-warning text-dark',
              'Faible': 'bg-light text-dark border'
            }[host[4]] %}
            <span class="ms-2 badge {{ prio_class }}">Priorit√©: {{ host[4] }}</span>
          {% endif %}
        </button>
      </h2>
      <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#hostAccordion">
        <div class="accordion-body">
          <form method="post" class="mb-3">
            <input type="hidden" name="ip" value="{{ host[0] }}">
            <div class="mb-2">
              <label>Tags</label>
              <input type="text" name="tags" class="form-control" value="{{ host[1] }}">
            </div>
            <div class="mb-2">
              <label>Priorit√©</label>
              <select name="priority" class="form-select">
                <option value="">Aucune</option>
                <option value="Faible" {% if host[4]=='Faible' %}selected{% endif %}>Faible</option>
                <option value="Moyenne" {% if host[4]=='Moyenne' %}selected{% endif %}>Moyenne</option>
                <option value="√âlev√©e" {% if host[4]=='√âlev√©e' %}selected{% endif %}>√âlev√©e</option>
              </select>
            </div>
            <div class="mb-2">
              <label>Checklist</label>
              <textarea name="checklist" class="form-control" rows="2">{{ host[2] }}</textarea>
            </div>
            <div class="mb-2">
              <label>Notes</label>
              <textarea name="notes" class="form-control" rows="3">{{ host[3] }}</textarea>
            </div>
            <div class="mb-2">
              <label>Nouvelle action (timeline)</label>
              <input type="text" name="action" class="form-control" placeholder="ex: dump lsass, lateral move...">
            </div>
            <button type="submit" class="btn btn-sm btn-success">Sauvegarder</button>
          </form>

          <h5>Ports ouverts</h5>
          <ul class="list-group mb-3">
            {% for port, proto in ports_data[host[0]] %}
              <li class="list-group-item">{{ proto }}/{{ port }}</li>
            {% endfor %}
          </ul>

          {% if actions_data[host[0]] %}
          <h5>Timeline des actions</h5>
          <ul class="list-group">
            {% for timestamp, action in actions_data[host[0]] %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{ action }}</span>
                <small class="text-muted">{{ timestamp }}</small>
              </li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
